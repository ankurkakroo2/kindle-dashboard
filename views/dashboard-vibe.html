<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="refresh" content="300">
    <meta name="viewport" content="width=1264, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        /* RESET & BASE */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: "Amazon Ember", "Helvetica", Arial, sans-serif;
            background: #ffffff;
            color: #000000;
            width: 1200px;
            height: 1580px;
            overflow: hidden;
            border-top: 10px solid #000; /* Top thick bar */
        }

        /* UTILS */
        .mono { font-family: "Courier New", Courier, monospace; letter-spacing: -1px; }
        .bold { font-weight: 900; }
        .caps { text-transform: uppercase; }
        .box {
            border: 3px solid #000;
            background: #fff;
            margin-bottom: 20px;
            position: relative;
        }
        /* Hard shadow simulation using a wrapper table or div offset would be ideal, 
           but for table layout simplicity, we'll use heavy borders and spacing. */
        
        /* LAYOUT TABLE */
        .layout-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 20px; /* Gap between columns */
            table-layout: fixed;
        }
        .col-left { width: 35%; vertical-align: top; }
        .col-right { width: 65%; vertical-align: top; }

        /* HEADER */
        .header-table { width: 100%; margin: 20px 0; border-bottom: 3px solid #000; padding-bottom: 10px; }
        .date-cell { text-align: left; font-size: 32px; font-weight: 900; }
        .time-cell { text-align: right; font-size: 32px; font-weight: 900; }
        
        /* CARDS */
        .card-header {
            background: #000;
            color: #fff;
            padding: 8px 12px;
            font-size: 18px;
            font-weight: 900;
            text-transform: uppercase;
            border-bottom: 3px solid #000;
        }
        .card-body { padding: 15px; }

        /* WEATHER */
        .weather-big { font-size: 80px; line-height: 0.8; font-weight: 900; }
        .weather-icon { font-size: 60px; margin-bottom: 10px; display: block; }
        .weather-meta { margin-top: 15px; font-size: 16px; border-top: 2px solid #000; padding-top: 10px; }
        .meta-row { display: block; margin-bottom: 5px; font-weight: 700; }

        /* TODOS */
        .todo-row {
            padding: 12px 0;
            border-bottom: 2px dashed #000;
            font-size: 16px;
            font-weight: 600;
        }
        .todo-row:last-child { border-bottom: none; }
        .check-box {
            display: inline-block;
            width: 20px; height: 20px;
            border: 3px solid #000;
            margin-right: 10px;
            vertical-align: middle;
            text-align: center;
            line-height: 14px;
            font-weight: 900;
        }

        /* TIMELINE / EVENTS (Vibe Style) */
        .event-card {
            border: 3px solid #000;
            margin-bottom: 15px;
            background: #fff;
            /* "Hard Shadow" effect */
            box-shadow: 6px 6px 0px #000; 
        }
        .event-time-bar {
            background: #000;
            color: #fff;
            padding: 4px 10px;
            font-size: 14px;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 8px;
        }
        .event-title { font-size: 20px; font-weight: 800; line-height: 1.2; margin-bottom: 4px; }
        .event-duration { font-size: 14px; color: #666; font-weight: 600; }

        /* REFRESH BTN */
        .refresh-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #000;
            color: #fff;
            font-weight: 900;
            padding: 10px 20px;
            font-size: 16px;
            cursor: pointer;
            box-shadow: 4px 4px 0px #fff, 8px 8px 0px #000;
            border: 2px solid #000; /* Inverted border for visibility */
            z-index: 999;
        }
    </style>
</head>
<body>

    <!-- REFRESH -->
    <div class="refresh-btn" onclick="window.location.reload()">REFRESH SYSTEM</div>

    <!-- HEADER -->
    <div style="padding: 0 20px;">
        <table class="header-table">
            <tr>
                <td class="date-cell" id="date-display">LOADING DATE...</td>
                <td class="time-cell mono" id="time-display">00:00</td>
            </tr>
        </table>
    </div>

    <!-- MAIN GRID -->
    <table class="layout-table">
        <tr>
            <!-- LEFT COLUMN: CONTEXT -->
            <td class="col-left">
                
                <!-- WEATHER CARD -->
                <div class="box">
                    <div class="card-header">ENVIRONMENT</div>
                    <div class="card-body" style="text-align: center;">
                        <span class="weather-icon" id="w-icon">--</span>
                        <div class="weather-big" id="w-temp">--Â°</div>
                        <div class="bold" style="font-size: 20px; margin-top: 5px;" id="w-city">GURUGRAM</div>
                        
                        <div class="weather-meta">
                            <span class="meta-row">FEELS: <span id="w-feels">--</span>Â°</span>
                            <span class="meta-row">HUMID: <span id="w-humid">--</span>%</span>
                            <span class="meta-row caps" id="w-cond">--</span>
                        </div>
                    </div>
                </div>

                <!-- TODOS CARD -->
                <div class="box">
                    <div class="card-header">TASKS</div>
                    <div class="card-body" id="todo-list">
                        <!-- Items injected here -->
                    </div>
                </div>

                 <!-- SYSTEM STATUS -->
                 <div class="box" style="border: 3px dashed #000; background: transparent;">
                    <div class="card-body">
                        <div class="bold" style="font-size: 14px;">SYSTEM STATUS</div>
                        <div class="mono" style="font-size: 12px; margin-top: 5px;">ONLINE</div>
                        <div class="mono" style="font-size: 12px;" id="last-update">UPDATED: --</div>
                    </div>
                </div>

            </td>

            <!-- RIGHT COLUMN: SCHEDULE -->
            <td class="col-right">
                <div style="border-bottom: 3px solid #000; margin-bottom: 20px; font-size: 24px; font-weight: 900;">
                    SCHEDULE STREAM
                </div>
                <div id="schedule-stream">
                    <!-- Event Cards injected here -->
                </div>
            </td>
        </tr>
    </table>

<script>
    // CONFIG
    const API_BASE = 'http://192.168.1.140:5001';

    function init() {
        updateTime();
        fetchData();
        // Refresh every 5 min
        setInterval(fetchData, 300000); 
        // Clock every 1s
        setInterval(updateTime, 1000);
    }

    function updateTime() {
        const now = new Date();
        const days = ['SUNDAY', 'MONDAY', 'TUESDAY', 'WEDNESDAY', 'THURSDAY', 'FRIDAY', 'SATURDAY'];
        const months = ['JAN', 'FEB', 'MAR', 'APR', 'MAY', 'JUN', 'JUL', 'AUG', 'SEP', 'OCT', 'NOV', 'DEC'];
        
        document.getElementById('date-display').innerText = `${days[now.getDay()]} ${now.getDate()} ${months[now.getMonth()]}`;
        
        let h = now.getHours();
        let m = now.getMinutes();
        let ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12; 
        h = h ? h : 12; 
        m = m < 10 ? '0'+m : m;
        document.getElementById('time-display').innerText = `${h}:${m}${ampm}`;
        
        document.getElementById('last-update').innerText = `SYNC: ${h}:${m}:${now.getSeconds()}`;
    }

    async function fetchData() {
        try {
            // Parallel fetch
            const [wRes, cRes, tRes] = await Promise.all([
                fetch(API_BASE + '/api/weather'),
                fetch(API_BASE + '/api/calendar'),
                fetch(API_BASE + '/api/todos')
            ]);

            const wData = await wRes.json();
            const cData = await cRes.json();
            const tData = await tRes.json();

            renderWeather(wData);
            renderCalendar(cData.events || []); // Fix: Access .events property
            renderTodos(tData);

        } catch (e) {
            console.error("Fetch failed", e);
        }
    }

    function renderWeather(data) {
        // Simple mapping
        const icons = { 0: 'â˜€ï¸', 1: 'ðŸŒ¤ï¸', 2: 'â˜ï¸', 3: 'â˜ï¸', 45: 'ðŸŒ«ï¸', 51: 'ðŸŒ§ï¸', 61: 'ðŸŒ§ï¸', 80: 'ðŸŒ§ï¸', 95: 'â›ˆï¸' };
        const conds = { 0: 'CLEAR', 1: 'PARTLY CLOUDY', 2: 'CLOUDY', 3: 'OVERCAST', 61: 'RAIN', 95: 'STORM' };
        
        document.getElementById('w-temp').innerText = Math.round(data.temp) + 'Â°';
        document.getElementById('w-feels').innerText = Math.round(data.feelsLike);
        document.getElementById('w-humid').innerText = data.humidity;
        document.getElementById('w-cond').innerText = conds[data.condition] || 'UNKNOWN';
        document.getElementById('w-icon').innerText = icons[data.condition] || 'â˜€ï¸';
    }

    function renderTodos(todos) {
        const list = document.getElementById('todo-list');
        list.innerHTML = '';
        todos.slice(0, 6).forEach(t => {
            list.innerHTML += `
                <div class="todo-row">
                    <span class="check-box">${t.completed ? 'âœ“' : ''}</span>
                    <span style="${t.completed ? 'text-decoration:line-through; color:#888' : ''}">${t.text.toUpperCase()}</span>
                </div>
            `;
        });
    }

    function renderCalendar(events) {
        const container = document.getElementById('schedule-stream');
        container.innerHTML = '';
        
        // Filter for upcoming 12 hours
        const now = new Date();
        const end = new Date(now.getTime() + 12 * 60 * 60 * 1000);

        // Sort
        events.sort((a,b) => new Date(a.start) - new Date(b.start));

        let hasEvents = false;
        events.forEach(e => {
            const start = new Date(e.start);
            const finish = new Date(e.end);
            
            // Only show if not ended
            if (finish < now) return;
            if (start > end) return;
            
            hasEvents = true;

            // Format times
            const sStr = formatTime(start);
            const eStr = formatTime(finish);

            // "Vibe" styling logic
            let borderStyle = 'solid';
            let bg = '#fff';
            if (e.type === 'meeting') { bg = '#f0f0f0'; }
            if (e.type === 'personal') { bg = '#fff'; borderStyle = 'dashed'; }
            
            container.innerHTML += `
                <div class="event-card" style="background:${bg}; border-style:${borderStyle}">
                    <div class="card-body">
                        <span class="event-time-bar mono">${sStr} - ${eStr}</span>
                        <div class="event-title">${e.title.toUpperCase()}</div>
                        <div class="event-duration mono">${getDuration(start, finish)} MIN</div>
                    </div>
                </div>
            `;
        });

        if (!hasEvents) {
            container.innerHTML = `<div class="box" style="text-align:center; padding:20px; font-weight:bold;">NO UPCOMING EVENTS</div>`;
        }
    }

    function formatTime(d) {
        let h = d.getHours();
        let m = d.getMinutes();
        const ampm = h >= 12 ? 'PM' : 'AM';
        h = h % 12 || 12;
        m = m < 10 ? '0'+m : m;
        return `${h}:${m}${ampm}`;
    }

    function getDuration(s, e) {
        return Math.round((e - s) / 60000);
    }

    init();
</script>
</body>
</html>