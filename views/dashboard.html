<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=1680, initial-scale=1, maximum-scale=1, user-scalable=no">
    <style>
        /* Kindle WebKit 1.0 compatible - table-based layout, system fonts, no flex/grid */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: "Amazon Ember", "Helvetica LT", Helvetica, Arial, sans-serif;
            background: #ffffff;
            color: #000000;
            width: 1680px;
            height: 1100px;
            overflow: hidden;
        }
        
        /* Main container */
        .main-container {
            display: table;
            width: 100%;
            height: 100%;
            border-collapse: collapse;
        }
        
        /* Header */
        .header {
            display: table-row;
            height: 70px;
        }
        
        .header-content {
            display: table-cell;
            padding: 16px 24px;
            border-bottom: 4px solid #000000;
            vertical-align: middle;
        }
        
        .header-left {
            float: left;
        }
        
        .header-right {
            float: right;
            text-align: right;
        }
        
        .date-large {
            font-size: 28px;
            font-weight: 900;
            line-height: 1.2;
        }
        
        .time-large {
            font-size: 20px;
            font-weight: 800;
            color: #333333;
        }
        
        .weather-summary {
            font-size: 24px;
            font-weight: 800;
        }
        
        /* Content area */
        .content {
            display: table-row;
            height: 1030px;
        }
        
        .content-wrapper {
            display: table-cell;
        }
        
        .content-inner {
            display: table;
            width: 100%;
            height: 1030px;
        }
        
        .content-row {
            display: table-row;
        }
        
        /* Left sidebar */
        .sidebar {
            display: table-cell;
            width: 420px;
            padding: 24px;
            border-right: 4px solid #000000;
            vertical-align: top;
        }
        
        /* Weather widget */
        .weather-widget {
            margin-bottom: 32px;
        }
        
        .weather-icon {
            font-size: 80px;
            text-align: center;
            margin-bottom: 12px;
        }
        
        .weather-temp {
            font-size: 64px;
            font-weight: 900;
            text-align: center;
            line-height: 1;
        }
        
        .weather-location {
            font-size: 14px;
            font-weight: 700;
            text-align: center;
            margin-top: 8px;
            color: #333333;
        }
        
        .weather-details {
            margin-top: 16px;
            padding: 12px 0;
            border-top: 2px solid #000000;
            border-bottom: 2px solid #000000;
        }
        
        .weather-detail-row {
            padding: 6px 0;
            font-size: 16px;
            font-weight: 800;
        }
        
        .weather-detail-label {
            display: inline-block;
            width: 120px;
        }
        
        .weather-detail-value {
            font-weight: 900;
        }
        
        /* Todos section */
        .todos-section {
            margin-top: 24px;
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 900;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 3px solid #000000;
        }
        
        .todo-item {
            padding: 10px 0;
            font-size: 15px;
            font-weight: 700;
            border-bottom: 1px solid #cccccc;
        }
        
        .todo-checkbox {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #000000;
            margin-right: 10px;
            vertical-align: middle;
            text-align: center;
            line-height: 14px;
            font-weight: 900;
        }
        
        .todo-completed {
            text-decoration: line-through;
            color: #666666;
        }
        
        /* Timeline area */
        .timeline {
            display: table-cell;
            padding: 16px 24px;
            vertical-align: top;
            position: relative;
        }
        
        .timeline-scroll {
            overflow-y: auto;
            overflow-x: hidden;
            height: 1000px;
            position: relative;
        }
        
        /* Hour grid */
        .hour-row {
            position: relative;
            height: 60px;
            border-bottom: 1px solid #dddddd;
        }
        
        .hour-label {
            position: absolute;
            left: 0;
            top: -10px;
            width: 80px;
            font-size: 14px;
            font-weight: 800;
            color: #000000;
        }
        
        .hour-line {
            position: absolute;
            left: 90px;
            right: 0;
            top: 0;
            border-top: 1px solid #dddddd;
        }
        
        /* Event blocks */
        .events-container {
            position: absolute;
            left: 90px;
            right: 0;
            top: 0;
            height: 100%;
        }
        
        .event-block {
            position: absolute;
            left: 0;
            border: 3px solid #000000;
            background: #ffffff;
            padding: 6px 10px;
            overflow: hidden;
        }
        
        .event-title {
            font-size: 13px;
            font-weight: 800;
            line-height: 1.2;
            overflow: hidden;
        }
        
        .event-time {
            font-size: 11px;
            font-weight: 700;
            color: #333333;
            margin-top: 2px;
        }
        
        /* Event types */
        .event-personal { background: #e8e8e8; }
        .event-work { background: #d0d0d0; }
        .event-meeting { background: #f5f5f5; }
        .event-tentative { border-style: dashed; background: #fafafa; }
        
        /* Current time indicator */
        .current-time-line {
            position: absolute;
            left: 90px;
            right: 0;
            height: 3px;
            background: #000000;
            z-index: 100;
        }
        
        .current-time-dot {
            position: absolute;
            left: -6px;
            top: -3px;
            width: 12px;
            height: 12px;
            background: #000000;
            border-radius: 50%;
        }
    </style>
</head>
<body>

<div class="main-container">
    <!-- Header -->
    <div class="header">
        <div class="header-content">
            <div class="header-left">
                <div class="date-large" id="current-date">Loading...</div>
                <div class="time-large" id="current-time">--:--</div>
            </div>
            <div class="header-right">
                <div class="weather-summary" id="weather-summary">‚òÄÔ∏è --¬∞ ‚Ä¢ Gurugram</div>
            </div>
        </div>
    </div>
    
    <!-- Content -->
    <div class="content">
        <div class="content-wrapper">
            <div class="content-inner">
                <div class="content-row">
                    <!-- Left Sidebar -->
                    <div class="sidebar">
                        <!-- Weather Widget -->
                        <div class="weather-widget">
                            <div class="weather-icon" id="weather-icon">‚òÄÔ∏è</div>
                            <div class="weather-temp" id="weather-temp">--¬∞</div>
                            <div class="weather-location">Gurugram, India</div>
                            <div class="weather-details">
                                <div class="weather-detail-row">
                                    <span class="weather-detail-label">Feels Like</span>
                                    <span class="weather-detail-value" id="feels-like">--¬∞</span>
                                </div>
                                <div class="weather-detail-row">
                                    <span class="weather-detail-label">Humidity</span>
                                    <span class="weather-detail-value" id="humidity">--%</span>
                                </div>
                                <div class="weather-detail-row">
                                    <span class="weather-detail-label">Condition</span>
                                    <span class="weather-detail-value" id="condition">--</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Todos -->
                        <div class="todos-section">
                            <div class="section-title">TODAY'S TASKS</div>
                            <div id="todos-list">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- Timeline -->
                    <div class="timeline">
                        <div class="timeline-scroll" id="timeline-scroll">
                            <div id="timeline-grid" style="position: relative; height: 1080px;">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// API Configuration
var API_BASE = 'http://192.168.1.140:5001';

// State
var weatherData = null;
var eventsData = null;
var todosData = null;

// Initialize
function init() {
    updateDateTime();
    setInterval(updateDateTime, 30000); // Update every 30 seconds
    
    fetchWeather();
    fetchCalendar();
    fetchTodos();
    
    setInterval(fetchWeather, 300000); // Refresh weather every 5 minutes
    setInterval(fetchCalendar, 300000); // Refresh calendar every 5 minutes
}

// Update date and time
function updateDateTime() {
    var now = new Date();
    var dateEl = document.getElementById('current-date');
    var timeEl = document.getElementById('current-time');
    
    var days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
    
    var dayName = days[now.getDay()];
    var monthName = months[now.getMonth()];
    var date = now.getDate();
    
    dateEl.textContent = dayName + ', ' + monthName + ' ' + date;
    
    var hours = now.getHours();
    var minutes = now.getMinutes();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    var displayHours = hours % 12 || 12;
    var displayMinutes = minutes < 10 ? '0' + minutes : minutes;
    
    timeEl.textContent = displayHours + ':' + displayMinutes + ' ' + ampm;
    
    // Update current time line
    updateCurrentTimeLine(now);
}

// Fetch weather
function fetchWeather() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', API_BASE + '/api/weather', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    weatherData = data;
                    updateWeatherUI(data);
                } catch (e) {
                    console.log('Weather parse error:', e);
                }
            } else {
                console.log('Weather fetch error:', xhr.status);
            }
        }
    };
    xhr.send();
}

// Update weather UI
function updateWeatherUI(data) {
    var temp = Math.round(data.temp || 0);
    var feelsLike = Math.round(data.feelsLike || 0);
    var humidity = Math.round(data.humidity || 0);
    var condition = mapCondition(data.condition);
    var icon = mapIcon(data.condition);
    
    document.getElementById('weather-icon').textContent = icon;
    document.getElementById('weather-temp').textContent = temp + '¬∞';
    document.getElementById('feels-like').textContent = feelsLike + '¬∞';
    document.getElementById('humidity').textContent = humidity + '%';
    document.getElementById('condition').textContent = condition;
    document.getElementById('weather-summary').textContent = icon + ' ' + temp + '¬∞ ‚Ä¢ Gurugram';
}

// Map weather condition
function mapCondition(code) {
    if (!code) return 'Clear';
    var c = Number(code);
    if (c === 0) return 'Sunny';
    if (c <= 3) return 'Partly Cloudy';
    if (c <= 48) return 'Foggy';
    if (c <= 55) return 'Drizzle';
    if (c <= 65) return 'Rain';
    if (c <= 75) return 'Snow';
    if (c <= 82) return 'Showers';
    return 'Cloudy';
}

// Map weather icon
function mapIcon(code) {
    if (!code) return '‚òÄÔ∏è';
    var c = Number(code);
    if (c === 0) return '‚òÄÔ∏è';
    if (c <= 3) return '‚õÖ';
    if (c <= 48) return 'üå´Ô∏è';
    if (c <= 65) return 'üåßÔ∏è';
    if (c <= 75) return '‚ùÑÔ∏è';
    return '‚òÅÔ∏è';
}

// Fetch calendar
function fetchCalendar() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', API_BASE + '/api/calendar', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    eventsData = data.events;
                    renderTimeline(data.events);
                } catch (e) {
                    console.log('Calendar parse error:', e);
                }
            } else {
                console.log('Calendar fetch error:', xhr.status);
            }
        }
    };
    xhr.send();
}

// Fetch todos
function fetchTodos() {
    var xhr = new XMLHttpRequest();
    xhr.open('GET', API_BASE + '/api/todos', true);
    xhr.onreadystatechange = function() {
        if (xhr.readyState === 4) {
            if (xhr.status === 200) {
                try {
                    var data = JSON.parse(xhr.responseText);
                    todosData = data;
                    renderTodos(data);
                } catch (e) {
                    console.log('Todos parse error:', e);
                }
            } else {
                console.log('Todos fetch error:', xhr.status);
            }
        }
    };
    xhr.send();
}

// Render todos
function renderTodos(todos) {
    var container = document.getElementById('todos-list');
    container.innerHTML = '';
    
    for (var i = 0; i < todos.length; i++) {
        var todo = todos[i];
        var item = document.createElement('div');
        item.className = 'todo-item';
        
        var checkbox = document.createElement('span');
        checkbox.className = 'todo-checkbox';
        checkbox.textContent = todo.completed ? '‚úì' : '';
        
        var text = document.createElement('span');
        text.textContent = todo.text;
        if (todo.completed) {
            text.className = 'todo-completed';
        }
        
        item.appendChild(checkbox);
        item.appendChild(text);
        container.appendChild(item);
    }
}

// Render timeline
function renderTimeline(events) {
    var grid = document.getElementById('timeline-grid');
    grid.innerHTML = '';
    
    // Create hour rows (6 AM to 11 PM = 18 hours)
    var startHour = 6;
    var endHour = 23;
    var totalHours = endHour - startHour + 1;
    var hourHeight = 60;
    
    grid.style.height = (totalHours * hourHeight) + 'px';
    
    // Draw hour grid
    for (var h = startHour; h <= endHour; h++) {
        var row = document.createElement('div');
        row.className = 'hour-row';
        row.style.top = ((h - startHour) * hourHeight) + 'px';
        row.style.position = 'absolute';
        row.style.width = '100%';
        row.style.height = hourHeight + 'px';
        
        var label = document.createElement('div');
        label.className = 'hour-label';
        var ampm = h >= 12 ? 'PM' : 'AM';
        var displayHour = h % 12 || 12;
        label.textContent = displayHour + ' ' + ampm;
        
        var line = document.createElement('div');
        line.className = 'hour-line';
        
        row.appendChild(label);
        row.appendChild(line);
        grid.appendChild(row);
    }
    
    // Create events container
    var eventsContainer = document.createElement('div');
    eventsContainer.className = 'events-container';
    eventsContainer.style.position = 'absolute';
    eventsContainer.style.left = '90px';
    eventsContainer.style.right = '0';
    eventsContainer.style.top = '0';
    eventsContainer.style.height = (totalHours * hourHeight) + 'px';
    
    // Calculate overlapping events and assign columns
    var sortedEvents = events.slice().sort(function(a, b) {
        return new Date(a.start) - new Date(b.start);
    });
    
    var columns = [];
    
    for (var i = 0; i < sortedEvents.length; i++) {
        var event = sortedEvents[i];
        var eventStart = new Date(event.start);
        var eventEnd = new Date(event.end);
        
        // Find a column for this event
        var placed = false;
        for (var c = 0; c < columns.length; c++) {
            var canPlace = true;
            for (var e = 0; e < columns[c].length; e++) {
                var existing = columns[c][e];
                var existingEnd = new Date(existing.end);
                if (eventStart < existingEnd) {
                    canPlace = false;
                    break;
                }
            }
            if (canPlace) {
                columns[c].push(event);
                event.column = c;
                event.totalColumns = columns.length;
                placed = true;
                break;
            }
        }
        
        if (!placed) {
            event.column = columns.length;
            event.totalColumns = columns.length + 1;
            columns.push([event]);
        }
    }
    
    // Update totalColumns for all events
    var maxColumns = columns.length;
    for (var i = 0; i < sortedEvents.length; i++) {
        sortedEvents[i].totalColumns = maxColumns;
    }
    
    // Render events
    for (var i = 0; i < sortedEvents.length; i++) {
        var event = sortedEvents[i];
        var eventStart = new Date(event.start);
        var eventEnd = new Date(event.end);
        
        var startHourFloat = eventStart.getHours() + eventStart.getMinutes() / 60;
        var endHourFloat = eventEnd.getHours() + eventEnd.getMinutes() / 60;
        
        // Skip events outside our view
        if (endHourFloat <= startHour || startHourFloat >= endHour + 1) continue;
        
        var topPos = (startHourFloat - startHour) * hourHeight;
        var height = (endHourFloat - startHourFloat) * hourHeight;
        
        var block = document.createElement('div');
        block.className = 'event-block event-' + (event.type || 'work');
        block.style.top = topPos + 'px';
        block.style.height = height + 'px';
        
        // Position based on column
        var columnWidth = 100 / event.totalColumns;
        block.style.left = (event.column * columnWidth) + '%';
        block.style.width = columnWidth + '%';
        
        var title = document.createElement('div');
        title.className = 'event-title';
        title.textContent = event.title;
        
        var time = document.createElement('div');
        time.className = 'event-time';
        var startStr = formatTime(eventStart);
        var endStr = formatTime(eventEnd);
        time.textContent = startStr + ' - ' + endStr;
        
        block.appendChild(title);
        if (height > 30) {
            block.appendChild(time);
        }
        
        eventsContainer.appendChild(block);
    }
    
    grid.appendChild(eventsContainer);
    
    // Scroll to current time
    scrollToCurrentTime();
}

// Format time
function formatTime(date) {
    var hours = date.getHours();
    var minutes = date.getMinutes();
    var ampm = hours >= 12 ? 'PM' : 'AM';
    var displayHours = hours % 12 || 12;
    var displayMinutes = minutes < 10 ? '0' + minutes : minutes;
    return displayHours + ':' + displayMinutes + ampm;
}

// Update current time line
function updateCurrentTimeLine(now) {
    var grid = document.getElementById('timeline-grid');
    if (!grid) return;
    
    var existing = document.getElementById('current-time-line');
    if (existing) {
        existing.parentNode.removeChild(existing);
    }
    
    var hours = now.getHours();
    var minutes = now.getMinutes();
    var currentHourFloat = hours + minutes / 60;
    
    var startHour = 6;
    var endHour = 23;
    var hourHeight = 60;
    
    if (currentHourFloat >= startHour && currentHourFloat <= endHour + 1) {
        var topPos = (currentHourFloat - startHour) * hourHeight;
        
        var line = document.createElement('div');
        line.id = 'current-time-line';
        line.className = 'current-time-line';
        line.style.top = topPos + 'px';
        
        var dot = document.createElement('div');
        dot.className = 'current-time-dot';
        line.appendChild(dot);
        
        grid.appendChild(line);
    }
}

// Scroll to current time
function scrollToCurrentTime() {
    var now = new Date();
    var hours = now.getHours();
    var minutes = now.getMinutes();
    var currentHourFloat = hours + minutes / 60;
    
    var startHour = 6;
    var hourHeight = 60;
    
    if (currentHourFloat >= startHour) {
        var scrollPos = (currentHourFloat - startHour - 2) * hourHeight;
        if (scrollPos < 0) scrollPos = 0;
        
        var scrollContainer = document.getElementById('timeline-scroll');
        scrollContainer.scrollTop = scrollPos;
    }
}

// Start
init();
</script>

</body>
</html>
